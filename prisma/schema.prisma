// This is your Prisma schema file for MongoDB

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ======================
// CORE USER MODELS
// ======================

model User {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  username          String   @unique
  email             String   @unique
  emailVerified     Boolean  @default(false)
  verificationToken String?
  password          String
  role              UserRole @default(STUDENT)
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relationships
  student      Student?
  auditLogs    AuditLog[]
  createdTasks Task[]     @relation("TaskCreator")

  @@map("users")
}

enum UserRole {
  STUDENT
  ADMIN
}

// ======================
// STUDENT PROFILE
// ======================

model Student {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @unique @db.ObjectId
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Personal Information
  firstName      String
  lastName       String
  email          String? // Duplicate for convenience, also in User
  phone          String?
  dateOfBirth    DateTime?
  gender         String?
  nationality    String?
  countryOfBirth String?
  nativeLanguage String?

  // Parent/Guardian Contact Information
  parentName  String?
  parentPhone String?
  parentEmail String?

  // Passport Information
  passportNumber        String?
  nameAsPerPassport     String?
  passportIssueLocation String?
  passportIssueDate     DateTime?
  passportExpiryDate    DateTime?

  // Address Information
  address    String?
  postalCode String?

  // Education Information
  // School (10th grade)
  school            String?
  schoolCountry     String?
  schoolAddress     String?
  schoolStartDate   DateTime?
  schoolEndDate     DateTime?
  schoolGrade       String? // Percentage
  
  // High School (12th grade)
  highSchool          String?
  highSchoolCountry   String?
  highSchoolAddress   String?
  highSchoolStartDate DateTime?
  highSchoolEndDate   DateTime?
  highSchoolGrade     String? // Percentage
  
  // Bachelor's Degree
  bachelorsIn           String?
  bachelorsFromInstitute String?
  bachelorsCountry      String?
  bachelorsAddress      String?
  bachelorsStartDate    DateTime?
  bachelorsEndDate      DateTime?
  bachelorsGrade        String?
  
  // Test Scores
  greTaken   Boolean? @default(false)
  greScore   String?
  toeflTaken Boolean? @default(false)
  toeflScore String?
  languageTest String? // IELTS, PTE, Duolingo
  languageTestScore String?

  // Travel History
  travelHistory Json? // Array of {startDate, endDate, country, reason}
  visaRefused Boolean? @default(false)
  visaRefusedCountry String?

  // Academic Information
  program    Program
  intakeYear Int

  // Batch Assignment (optional - student can be unassigned)
  batchId String? @db.ObjectId
  batch   Batch?  @relation(fields: [batchId], references: [id])

  // Profile Status
  hasCompletedOnboarding Boolean @default(false)
  hasWorkExperience      Boolean @default(false)

  // Financial Information
  // Personal
  personalEverEmployed String? // 'YES' or 'NO'
  personalTakingLoan String? // 'YES' or 'NO'
  personalLoanAmount String?
  personalLoanBankName String?
  // Mother
  motherIncomeType String? // 'SALARIED' or 'BUSINESS'
  // Father
  fatherIncomeType String? // 'SALARIED' or 'BUSINESS'
  // Other Sources (array of {name, relationship, age, dateOfBirth, incomeType})
  otherSources Json? // Array of other income sources with details

  // Timestamps
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  archivedAt DateTime? // For soft delete

  // Relationships
  documents       Document[]
  tasks           TaskAssignment[]
  workExperiences WorkExperience[]

  @@index([batchId])
  @@map("students")
}

enum Program {
  BS
  BBA
}

// ======================
// WORK EXPERIENCE & REFERENCES
// ======================

model WorkExperience {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  studentId String  @db.ObjectId
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  // Job Details
  jobTitle             String
  organizationName     String
  organizationAddress  String?
  organizationContact  String?
  startDate            DateTime
  endDate              DateTime

  // Certificate
  certificateFileName   String? // Original filename
  certificateStoredPath String? // Server file path
  certificateFileSize   Int? // Bytes
  certificateMimeType   String?

  // Letter of Recommendation
  lorFileName   String? // Original filename
  lorStoredPath String? // Server file path
  lorFileSize   Int? // Bytes
  lorMimeType   String?

  // Salary Slip
  salarySlipFileName   String? // Original filename
  salarySlipStoredPath String? // Server file path
  salarySlipFileSize   Int? // Bytes
  salarySlipMimeType   String?

  // Reference (embedded - can be null if no reference)
  reference Reference?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId])
  @@map("work_experiences")
}

model Reference {
  id               String         @id @default(auto()) @map("_id") @db.ObjectId
  workExperienceId String         @unique @db.ObjectId
  workExperience   WorkExperience @relation(fields: [workExperienceId], references: [id], onDelete: Cascade)

  // Reference Details
  name                    String
  position                String
  title                   String?
  workEmail               String
  phone                   String
  durationKnown           String?
  relationship            String?
  institution             String?
  institutionAddress      String?

  // Reference Document
  documentFileName   String? // Original filename
  documentStoredPath String? // Server file path
  documentFileSize   Int? // Bytes
  documentMimeType   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("references")
}

// ======================
// BATCH MANAGEMENT
// ======================

model Batch {
  id         String  @id @default(auto()) @map("_id") @db.ObjectId
  program    Program
  intakeYear Int

  // Auto-generated batch name
  name String @unique // e.g., "BS-2024"

  // Status
  isActive   Boolean   @default(true)
  archivedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  students  Student[]
  tasks     TaskAssignment[]
  resources Resource[]

  // Compound unique index to prevent duplicate batches
  @@unique([program, intakeYear])
  @@map("batches")
}

// ======================
// DOCUMENT MANAGEMENT
// ======================

model Document {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  studentId String  @db.ObjectId
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  type       DocumentType
  fileName   String // Original filename
  storedPath String // Server file path
  fileSize   Int // Bytes
  mimeType   String

  // For tracking which "other source" this document belongs to (if applicable)
  otherSourceIndex Int? // Index in the otherSources array

  // Document verification
  isVerified Boolean   @default(false)
  verifiedBy String? // Admin user ID
  verifiedAt DateTime?

  // Metadata
  uploadedAt DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Audit
  accessLogs DocumentAccessLog[]

  @@index([studentId])
  @@index([type])
  @@map("documents")
}

enum DocumentType {
  PASSPORT
  AADHAR_CARD
  DRIVERS_LICENSE
  IELTS
  VISA
  I20
  TRANSCRIPT
  MARKSHEET_10TH
  MARKSHEET_12TH
  GRE_SCORECARD
  TOEFL_SCORECARD
  LANGUAGE_TEST_SCORECARD
  OTHER
  // Financial Documents - Personal
  PERSONAL_PAN_CARD
  PERSONAL_ITR
  PERSONAL_SALARY_SLIPS
  PERSONAL_SALARY_ACCOUNT_STATEMENT
  PERSONAL_SAVING_ACCOUNT_STATEMENT
  PERSONAL_FD_RECEIPTS
  PERSONAL_BALANCE_CERT_SAVINGS
  PERSONAL_BALANCE_CERT_BUSINESS
  PERSONAL_BALANCE_CERT_FD
  PERSONAL_LOAN_SANCTION_LETTER
  PERSONAL_LOAN_DISBURSEMENT_LETTER
  PERSONAL_LOAN_AGREEMENT
  // Financial Documents - Mother
  MOTHER_PAN_CARD
  MOTHER_ITR
  MOTHER_ITR_COMPUTATION
  MOTHER_SALARY_ACCOUNT_STATEMENT
  MOTHER_SALARY_SLIPS
  MOTHER_SAVING_ACCOUNT_STATEMENT
  MOTHER_FD_RECEIPTS
  MOTHER_BALANCE_CERT_SAVINGS
  MOTHER_BALANCE_CERT_BUSINESS
  MOTHER_BALANCE_CERT_FD
  MOTHER_GST_CERTIFICATE
  MOTHER_BUSINESS_REGISTRATION
  // Financial Documents - Father
  FATHER_PAN_CARD
  FATHER_ITR
  FATHER_ITR_COMPUTATION
  FATHER_SALARY_ACCOUNT_STATEMENT
  FATHER_SALARY_SLIPS
  FATHER_SAVING_ACCOUNT_STATEMENT
  FATHER_FD_RECEIPTS
  FATHER_BALANCE_CERT_SAVINGS
  FATHER_BALANCE_CERT_BUSINESS
  FATHER_BALANCE_CERT_FD
  FATHER_GST_CERTIFICATE
  FATHER_BUSINESS_REGISTRATION
  // Financial Documents - Other
  OTHER_SOURCE_PAN_CARD
  OTHER_SOURCE_ITR
  OTHER_SOURCE_ITR_COMPUTATION
  OTHER_SOURCE_SALARY_ACCOUNT_STATEMENT
  OTHER_SOURCE_SALARY_SLIPS
  OTHER_SOURCE_SAVING_ACCOUNT_STATEMENT
  OTHER_SOURCE_FD_RECEIPTS
  OTHER_SOURCE_BALANCE_CERT_SAVINGS
  OTHER_SOURCE_BALANCE_CERT_BUSINESS
  OTHER_SOURCE_BALANCE_CERT_FD
  OTHER_SOURCE_GST_CERTIFICATE
  OTHER_SOURCE_BUSINESS_REGISTRATION
}

// ======================
// TASK MANAGEMENT
// ======================

model Task {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String
  dueDate     DateTime?

  // Assignment scope
  assignmentType TaskAssignmentType

  // Creator
  createdById String @db.ObjectId
  createdBy   User   @relation("TaskCreator", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  assignments TaskAssignment[]

  @@map("tasks")
}

enum TaskAssignmentType {
  INDIVIDUAL
  BATCH
  PROGRAM
}

// Task Assignment Junction Table
model TaskAssignment {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  taskId String @db.ObjectId
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  // Can be assigned to student OR batch
  studentId String?  @db.ObjectId
  student   Student? @relation(fields: [studentId], references: [id], onDelete: Cascade)

  batchId String? @db.ObjectId
  batch   Batch?  @relation(fields: [batchId], references: [id], onDelete: Cascade)

  // Status
  status      TaskStatus @default(PENDING)
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([taskId])
  @@index([studentId])
  @@index([batchId])
  @@map("task_assignments")
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  OVERDUE
}

// ======================
// RESOURCE MANAGEMENT
// ======================

model Resource {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?

  // File information
  fileName   String
  storedPath String
  fileSize   Int
  mimeType   String

  // Visibility scope
  visibilityType ResourceVisibility
  program        Program?

  // Can be visible to specific batch
  batchId String? @db.ObjectId
  batch   Batch?  @relation(fields: [batchId], references: [id])

  uploadedAt DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([batchId])
  @@index([program])
  @@map("resources")
}

enum ResourceVisibility {
  BATCH
  PROGRAM
  ALL
}

// ======================
// EMAIL TRACKING
// ======================

model EmailLog {
  id        String      @id @default(auto()) @map("_id") @db.ObjectId
  recipient String
  subject   String
  body      String
  status    EmailStatus @default(PENDING)
  error     String?

  sentAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([status])
  @@index([createdAt])
  @@map("email_logs")
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
}

// ======================
// AUDIT LOGGING
// ======================

model AuditLog {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  action    String // e.g., "CREATE_STUDENT", "DELETE_DOCUMENT"
  entity    String // e.g., "Student", "Document"
  entityId  String? // ID of affected entity
  details   String? // JSON string of additional details
  ipAddress String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// Document access tracking
model DocumentAccessLog {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  documentId String   @db.ObjectId
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  accessedBy String // User ID or email
  action     String // "VIEW", "DOWNLOAD"
  ipAddress  String?

  createdAt DateTime @default(now())

  @@index([documentId])
  @@index([createdAt])
  @@map("document_access_logs")
}

// ======================
// EVENT MANAGEMENT
// ======================

model Event {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String
  eventDate   DateTime
  eventTime   String // Store as string (e.g., "12:00")
  venue       String
  
  // Banner image
  banner      String? // File path or auto-generated based on name
  
  // Registration
  registrationLink String?
  
  // Resources (file paths)
  resources String[] @default([]) // Array of file paths
  
  // Batch assignment - store array of batch IDs
  batchIds String[] @db.ObjectId @default([])
  
  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([eventDate])
  @@map("events")
}
